<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ Thống Quản Lý Nhân Sự</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body {
            background-color: #f0f2f5;
            font-family: 'Segoe UI', sans-serif;
        }

        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .form-control:focus {
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.15);
        }
        .is-invalid {
            border-color: #dc3545 !important;
            background-image: none !important;
        }

        .error-msg {
            color: #dc3545;
            font-size: 0.8rem;
            margin-top: 4px;
            display: none;
        }

        input[readonly] {
            background-color: #e9ecef;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="container py-5">

    <h3 class="text-center fw-bold mb-4 text-primary text-uppercase">Hệ Thống Quản Lý Người Dùng</h3>

    <input type="hidden" id="hiddenId" value="0">

    <div class="card mb-4">
        <div class="card-header bg-white py-3 border-0">
            <h6 class="m-0 text-primary fw-bold"><i class="fa-solid fa-user-pen me-2"></i>Thông Tin Chi Tiết</h6>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-2">
                    <label class="form-label">Mã NV</label>
                    <input type="text" id="displayId" class="form-control" placeholder="Auto" readonly>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Họ Tên <span class="text-danger">*</span></label>
                    <input type="text" id="name" class="form-control" placeholder="Nguyễn Văn A">
                    <div class="error-msg" id="err-name">Vui lòng nhập họ tên</div>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Ngày Sinh <span class="text-danger">*</span></label>
                    <input type="date" id="dob" class="form-control">
                    <div class="error-msg" id="err-dob">Vui lòng chọn ngày sinh</div>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Email <span class="text-danger">*</span></label>
                    <input type="email" id="email" class="form-control" placeholder="name@company.com">
                    <div class="error-msg" id="err-email">Email không hợp lệ</div>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Điện Thoại <span class="text-danger">*</span></label>
                    <input type="text" id="phone" class="form-control" placeholder="09xx xxx xxx">
                    <div class="error-msg" id="err-phone">SĐT phải là số (10-11 số)</div>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Địa Chỉ</label>
                    <input type="text" id="address" class="form-control" placeholder="Địa chỉ thường trú">
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <div class="w-100 d-flex gap-2">
                        <button onclick="resetForm()" id="btnCancel" class="btn btn-secondary w-25 d-none"><i class="fa-solid fa-xmark"></i></button>
                        <button onclick="saveUser()" id="btnSave" class="btn btn-primary flex-grow-1"><i class="fa-solid fa-floppy-disk me-1"></i> Lưu Dữ Liệu</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header bg-white py-3 border-0 d-flex justify-content-between align-items-center">
            <h6 class="m-0 text-dark fw-bold"><i class="fa-solid fa-list-ul me-2"></i>Danh Sách Nhân Sự</h6>
            <span class="badge bg-primary rounded-pill" id="countBadge">0</span>
        </div>
        <div class="card-body p-0">
            <table class="table table-hover mb-0 align-middle">
                <thead class="table-light">
                    <tr>
                        <th class="ps-4">MÃ</th>
                        <th>THÔNG TIN NHÂN VIÊN</th>
                        <th>LIÊN HỆ</th>
                        <th>NGÀY SINH</th>
                        <th class="text-center">THAO TÁC</th>
                    </tr>
                </thead>
                <tbody id="userTableBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        const apiUrl = '/api/Users';

        function validateForm() {
            let isValid = true;

            const showError = (id, show) => {
                const el = document.getElementById(id);
                const msg = document.getElementById('err-' + id);
                if (show) {
                    el.classList.add('is-invalid');
                    if (msg) msg.style.display = 'block';
                    isValid = false;
                } else {
                    el.classList.remove('is-invalid');
                    if (msg) msg.style.display = 'none';
                }
            };

            const name = document.getElementById('name').value.trim();
            const email = document.getElementById('email').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const dob = document.getElementById('dob').value;

            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            const phoneRegex = /^0\d{9,10}$/;

            showError('name', name === "");
            showError('dob', dob === "");
            showError('email', !emailRegex.test(email));
            showError('phone', !phoneRegex.test(phone));

            return isValid;
        }

        async function loadUsers() {
            try {
                const res = await fetch(apiUrl);
                const users = await res.json();
                document.getElementById('countBadge').innerText = users.length;

                let html = '';
                users.forEach(u => {
                    const dateStr = u.dateOfBirth ? new Date(u.dateOfBirth).toLocaleDateString('vi-VN') : '';
                    const displayCode = `NV${String(u.id).padStart(3, '0')}`;

                    html += `<tr>
                            <td class="ps-4 fw-bold text-primary">${displayCode}</td>
                            <td>
                                <div class="fw-bold text-dark">${u.fullName}</div>
                                <div class="small text-muted"><i class="fa-solid fa-location-dot me-1"></i>${u.address || '---'}</div>
                            </td>
                            <td>
                                <div class="small"><i class="fa-regular fa-envelope me-1 text-secondary"></i> ${u.email}</div>
                                <div class="small"><i class="fa-solid fa-phone me-1 text-secondary"></i> ${u.phoneNumber}</div>
                            </td>
                            <td>${dateStr}</td>
                            <td class="text-center">
                                <button class="btn btn-outline-info btn-sm me-1" onclick="editUser(${u.id})"><i class="fa-solid fa-pen"></i></button>
                                <button class="btn btn-outline-danger btn-sm" onclick="deleteUser(${u.id})"><i class="fa-solid fa-trash"></i></button>
                            </td>
                        </tr>`;
                });
                document.getElementById('userTableBody').innerHTML = html || '<tr><td colspan="5" class="text-center py-4 text-muted">Chưa có dữ liệu</td></tr>';
            } catch (e) { console.error(e); }
        }

        async function editUser(id) {
            document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
            document.querySelectorAll('.error-msg').forEach(el => el.style.display = 'none');

            const res = await fetch(`${apiUrl}/${id}`);
            if (res.ok) {
                const u = await res.json();
                document.getElementById('hiddenId').value = u.id;
                document.getElementById('displayId').value = `NV${String(u.id).padStart(3, '0')}`;
                document.getElementById('name').value = u.fullName;
                document.getElementById('email').value = u.email;
                document.getElementById('phone').value = u.phoneNumber;
                document.getElementById('address').value = u.address || "";
                if (u.dateOfBirth) document.getElementById('dob').value = u.dateOfBirth.split('T')[0];

                const btn = document.getElementById('btnSave');
                btn.innerHTML = '<i class="fa-solid fa-check me-1"></i> Cập Nhật';
                btn.className = "btn btn-success flex-grow-1";
                document.getElementById('btnCancel').classList.remove('d-none');
                window.scrollTo(0, 0);
            }
        }


        async function saveUser() {
            if (!validateForm()) return;

            const id = parseInt(document.getElementById('hiddenId').value);
            const user = {
                id: id,
                fullName: document.getElementById('name').value.trim(),
                email: document.getElementById('email').value.trim(),
                phoneNumber: document.getElementById('phone').value.trim(),
                address: document.getElementById('address').value.trim(),
                dateOfBirth: document.getElementById('dob').value
            };

            const isUpdate = id > 0;
            const res = await fetch(isUpdate ? `${apiUrl}/${id}` : apiUrl, {
                method: isUpdate ? 'PUT' : 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(user)
            });

            if (res.ok) {
                alert("Thành công!");
                resetForm();
                loadUsers();
            } else {
                const errData = await res.json();
                alert("Lỗi từ hệ thống: " + JSON.stringify(errData.errors || "Lỗi không xác định"));
            }
        }

        function deleteUser(id) {
            if (confirm('Xóa nhân sự này?')) {
                fetch(`${apiUrl}/${id}`, { method: 'DELETE' }).then(() => loadUsers());
            }
        }

        function resetForm() {
            document.getElementById('hiddenId').value = "0";
            document.getElementById('displayId').value = "";
            document.querySelectorAll('input:not([type=hidden])').forEach(i => i.value = "");

            document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
            document.querySelectorAll('.error-msg').forEach(el => el.style.display = 'none');

            const btn = document.getElementById('btnSave');
            btn.innerHTML = '<i class="fa-solid fa-floppy-disk me-1"></i> Lưu Dữ Liệu';
            btn.className = "btn btn-primary flex-grow-1";
            document.getElementById('btnCancel').classList.add('d-none');
        }

        loadUsers();
    </script>
</body>
</html>